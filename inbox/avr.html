<h1>Where does the vector table come from?</h1>
<p>TL;DR: <code>avr-libc/crt1/gcrt1.S</code></p>
<p>I came across the concept of &quot;relocations&quot; while reviewing objects generated by my research. Relocatable sections are an ELF thing (well, the concept is in a lot of object file formats, but I care about ELF in this case). Support for specific types of relocations are found in these source files:</p>
<ul>
<li><code>~/src/gcc-dev/binutils-2.32/include/elf/avr.h</code></li>
<li><code>~/src/gcc-dev/binutils-2.32/bfd/elf-avr.h</code></li>
</ul>
<p>For example, the relocation <code>R_AVR_LDI</code> has number 19 (which is what is stored in the ELF field) is implemented in <code>elf32-avr.c</code> in the parts of the file where you can fine <code>R_AVR_LDI</code> (I don't know exactly how this works yet).</p>
<p>The actual vector table is defined in <code>avr-libc-1.8.1/crt1/gcrt1.S</code>. The section <code>.vectors</code> is created and a global label <code>__vectors</code> is defined in it. Each entry that follows uses the <code>vector</code> macro defined in this file:</p>
<pre><code class="language-avr-asm">.macro	vector name
.if (. - __vectors &lt; _VECTORS_SIZE)
.weak	\name
.set	\name, __bad_interrupt
XJMP	\name
.endif
.endm
</code></pre>
<p>And is used like this:</p>
<pre><code class="language-avr-asm">	.section .vectors,&quot;ax&quot;,@progbits
	.global	__vectors
	.func	__vectors
__vectors:
	XJMP	__init
	vector	__vector_1
	# ...
</code></pre>
<p>Which does some important stuff:</p>
<ul>
<li>Only define entries for vectors that are supported by the target architecture. This is done by subtracting the current address from the <code>__vectors</code> label address and making sure it less than <code>_VECTORS_SIZE</code> which is defined in the header for the part(s) that the library is being compiled for (e.g. <code>avr/iomxx0_1.h</code>). It's important to note that a library is generated for every avr-libc supported part, e.g. <code>&lt;build&gt;/avr/lib/avr6/atmega2560/libcrt.a</code>, which is how this vector table with variable number of entires works.</li>
<li>Set the vector name (e.g. <code>__vector_1</code>) to be a <code>weak</code> symbol which means that a non-<code>weak</code> symbol declared in another object file would override the definition from this file. This allows the library to contain a default implementation of the function that can be replaced by a user function defined outside of the library</li>
<li>Assign a default interrupt handler, <code>__bad_interrupt</code>, to the vector name that will handle unexpected interrupts (e.g. interrupts enabled by accident or interrupts intentionally enabled but that a handler was not implemented for by accident)</li>
<li>Emit the assembly instruction <code>XJMP</code> to jump to the interrupt handler</li>
</ul>
